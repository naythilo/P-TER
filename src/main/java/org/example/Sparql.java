package org.example;

import org.eclipse.rdf4j.federated.FedXConfig;
import org.eclipse.rdf4j.federated.FedXFactory;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.TupleQuery;
import org.eclipse.rdf4j.query.TupleQueryResult;
import org.eclipse.rdf4j.repository.Repository;
import org.eclipse.rdf4j.repository.RepositoryConnection;

public class Sparql {

    public static void main(String[] args) throws InterruptedException {
        FedXConfig config = new FedXConfig().withLogQueries(true);
        Repository repository = FedXFactory.newFederation()
                //.withSparqlEndpoint("http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/")
                //.withSparqlEndpoint("http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/")
                //.withSparqlEndpoint("http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/")
                .withConfig(config)
                .create();
        long startTime = System.nanoTime();

        try (RepositoryConnection conn = repository.getConnection()) {

            String query =
                    "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#> "
                            + "PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> "
                            + "PREFIX bsbm: <http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/vocabulary/> "
                            + "PREFIX owl: <http://www.w3.org/2002/07/owl#> "
                            + "SELECT DISTINCT ?product ?localProductLabel WHERE { "
                            + "    VALUES ( ?bgp1 ?bgp2 ) { ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite6.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor44.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite0.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite74.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite81.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite85.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite90.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor38.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite65.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.vendor3.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite70.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor76.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite57.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite62.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite87.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.vendor60.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) ( <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite22.fr/> <http://localhost:8890/sparql?default-graph-uri=http://www.ratingsite61.fr/> ) }\n"

                            + "  SERVICE ?bgp2 { "
                            + "    ?localProductXYZ owl:sameAs bsbm:Product136030 . "
                            + "    ?localProductXYZ bsbm:productFeature ?localProdFeatureXYZ . "
                            + "    ?localProdFeatureXYZ owl:sameAs ?prodFeature . "
                            + "    ?localProductXYZ bsbm:productPropertyNumeric1 ?origProperty1 . "
                            + "    ?localProductXYZ bsbm:productPropertyNumeric2 ?origProperty2 . "
                            + "  } "
                            + "  SERVICE ?bgp1 { "
                            + "    ?localProduct owl:sameAs ?product . "
                            + "    FILTER (bsbm:Product136030 != ?product) "
                            + "    ?localProduct rdfs:label ?localProductLabel . "
                            + "    ?localProduct bsbm:productFeature ?localProdFeature . "
                            + "    ?localProdFeature owl:sameAs ?prodFeature . "
                            + "    ?localProduct bsbm:productPropertyNumeric1 ?simProperty1 . "
                            + "    ?localProduct bsbm:productPropertyNumeric2 ?simProperty2 . "
                            + "  } "

                            + "  FILTER(?simProperty1 < (?origProperty1 + 20) && ?simProperty1 > (?origProperty1 - 20)) "
                            + "  FILTER(?simProperty2 < (?origProperty2 + 70) && ?simProperty2 > (?origProperty2 - 70)) "
                            + "} "
                            + "ORDER BY ?product ?localProductLabel "
                            + "LIMIT 5";


            TupleQuery tq = conn.prepareTupleQuery(query);
            try (TupleQueryResult tqRes = tq.evaluate()) {
                int count = 0;


                while (tqRes.hasNext()) {
                    BindingSet b = tqRes.next();
                    System.out.println(b);
                    count++;

                }

                System.out.println("Results: " + count);

                // Enregistrement du temps de fin de la requête
                long endTime = System.nanoTime();

                // Calcul du temps écoulé en secondes
                long duration = (endTime - startTime) / 1000000; // En millisecondes

                // Affichage du temps d'exécution
                System.out.println("Execution Time: " + duration + " ms");
            }
        }

        // Fermez la fédération après utilisation
        repository.shutDown();
    }
}
